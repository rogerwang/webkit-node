#!/usr/bin/make -f

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

DEB_HOST_GNU_TYPE   ?= $(shell dpkg-architecture -qDEB_HOST_GNU_TYPE)
DEB_BUILD_GNU_TYPE  ?= $(shell dpkg-architecture -qDEB_BUILD_GNU_TYPE)

GTK_VERSIONS = 2.0

CFLAGS = -g -Wall -Wl,--as-needed

ifneq (,$(filter noopt,$(DEB_BUILD_OPTIONS)))
        CFLAGS += -O0
else
ifeq (armhf,$(filter $(DEB_BUILD_ARCH),armhf))
	CFLAGS += -O1
else
        CFLAGS += -O2
endif
endif

ifeq ($(DEB_BUILD_ARCH),alpha)
        CFLAGS += -Wl,--no-relax
endif

ifneq (,$(findstring $(DEB_BUILD_ARCH),mips mipsel s390 s390x))
        CFLAGS += -gstabs
endif

ifneq (,$(filter parallel=%,$(DEB_BUILD_OPTIONS)))
	NUMJOBS = $(patsubst parallel=%,%,$(filter parallel=%,$(DEB_BUILD_OPTIONS)))
	MAKEARGUMENTS += -j$(NUMJOBS)
endif

clean:
	dh_testdir
	dh_testroot

	rm -f build-stamp install-stamp
	-test -d build/Source/WebKit/gtk/docs && \
		cd build/Source/WebKit/gtk/docs && \
		make maintainer-clean

	-rm -rf Source/WebKit/gtk/docs/xml* Source/WebKit/gtk/docs/html* Source/WebKit/gtk/docs/sgml.stamp Source/WebKit/gtk/docs/tmpl*
	-for file in Source/WebKit/gtk/docs/webkitgtk.prerequisites Source/WebKit/gtk/docs/tmpl.stamp \
		Source/WebKit/gtk/docs/webkitgtk-overrides.txt Source/WebKit/gtk/docs/webkitgtk.args \
		Source/WebKit/gtk/docs/webkitgtk.interfaces Source/WebKit/gtk/docs/webkitgtk.signals \
		Source/WebKit/gtk/docs/webkitgtk.hierarchy Source/WebKit/gtk/docs/tmpl/webkitgtk-unused.sgml \
		Source/WebKit/gtk/docs/webkitgtk-decl-list.txt Source/WebKit/gtk/docs/webkitgtk-decl.txt \
		Source/WebKit/gtk/docs/webkitgtk-undeclared.txt Source/WebKit/gtk/docs/webkitgtk-undocumented.txt \
		Source/WebKit/gtk/docs/webkitgtk-unused.txt; do \
		rm -f ${file}; \
	done
	rm -rf build-*
	rm -rf debian/tmp-*
	rm -f Source/WebKit/gtk/docs/version.xml

	for file in config.guess config.sub; do \
		sed -i '2!b;/^exec "/ d' Source/autotools/$$file ; \
	done

	dh_clean

build: build-stamp

build-stamp:
	dh_testdir

	for file in config.guess config.sub; do \
		sed -i '2!b;/^#/ i\exec "/usr/share/misc/'$$file'" "$$@"' Source/autotools/$$file ; \
	done

	# FIXME: upstream is broken when running pot-update, is why we
	# create the po directory manually here
	for version in $(GTK_VERSIONS); do \
		if [ ! -d build-$${version} ]; then \
			mkdir build-$${version}; \
			mkdir -p build-$${version}/Source/WebKit/gtk/po/; \
		fi; \
		cd build-$${version}; \
		env AR_FLAGS="cruT" \
		CFLAGS="$(CFLAGS)" \
		CXXFLAGS="$(CFLAGS)" \
		CC="gcc" \
		CXX="g++" \
		../configure --prefix=/usr \
			--disable-silent-rules \
			--host=$(DEB_HOST_GNU_TYPE) \
			--build=$(DEB_BUILD_GNU_TYPE) \
			--with-gtk=$${version} \
            --with-jsengine=v8 \
		cd ..; \
	done

	for version in $(GTK_VERSIONS); do \
		$(MAKE) $(MAKEARGUMENTS) -C build-$${version}; \
	done

	touch $@

install: install-stamp

install-stamp: build-stamp
	dh_testdir
	dh_testroot

	dh_clean -k

ifeq (2.0,$(filter 2.0,$(GTK_VERSIONS)))
	$(MAKE) -C build-2.0 install DESTDIR="$(CURDIR)"/debian/tmp-2.0
	[ ! -d debian/tmp-2.0/usr/lib/webkitgtk-1.0-0/libexec ] && install -d -m 755 debian/tmp-2.0/usr/lib/webkitgtk-1.0-0/libexec || true

endif

	touch $@

# Build architecture-independent files here.
binary-indep: build install
	dh_testdir
	dh_testroot
	dh_installdocs -i
	dh_installchangelogs -i
	dh_link -i
	dh_compress -i
	dh_fixperms -i
	dh_installdeb -i
	dh_gencontrol -i
	dh_md5sums -i
	dh_builddeb -i

# Build architecture-dependent files here.
binary-arch: build install
	dh_testdir
	dh_testroot
	dh_installdocs -a
	dh_installchangelogs -a
ifeq (2.0,$(filter 2.0,$(GTK_VERSIONS)))
	dh_install -plibwebkitnode-1.0-0 --sourcedir=debian/tmp-2.0
	dh_install -plibwebkitnode-dev --sourcedir=debian/tmp-2.0
	dh_install -plibwebkitnode-1.0-0-dbg --sourcedir=debian/tmp-2.0
endif
	dh_link -a
ifeq (2.0,$(filter 2.0,$(GTK_VERSIONS)))
	dh_strip -plibwebkitnode-1.0-0 --dbg-package=libwebkitnode-1.0-0-dbg
endif
	dh_compress -a
	dh_fixperms -a
ifeq (2.0,$(filter 2.0,$(GTK_VERSIONS)))
	dh_makeshlibs -plibwebkitnode-1.0-0 -V 'libwebkitnode-1.0-0 (>= 1.3.9)' -- -c4
endif
	dh_installdeb -a
	dh_shlibdeps -a
	dh_gencontrol -a
	dh_md5sums -a
	dh_builddeb -a

binary: binary-indep binary-arch

.PHONY: build clean install binary binary-indep binary-arch
